{% extends './base.html' %}
{% block content %}
<link href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
#menu {
    position: absolute;
    background: #efefef;
    padding: 10px;
    font-family: 'Open Sans', sans-serif;
    color: black;
  }
</style>
</head>
<body>
<a href="/backend/" class="p-2 mb-3 btn btn-secondary">‚Üê BACK</a>
<div class="container w-100 border rounded shaded text-light">
  <div class="row">
    <h2 class="pl-4">Search results for </h2>
    <h2 class="pl-2"> '{{ searched_job|title }}' </h2>
    <div class="pl-1 mt-2">
          <h5 class="mb-2">(<u>{{ job_count }}</u> jobs found)</h5>
    </div> 
  </div>
  <div class="row">
    <div class="left-content col-lg-4">
      <div class="pl-1 mt-3">
        <div class="card mt-3 bg-info">
          <div class="card-body"><span style="color: black">
          <h5>In-Demand Languages: </h5>
          <p>
              <ol>
                  {% for lang in lang_count|slice:":5" %}
                    <li>{{lang}}</li>
                  {% endfor %}
              </ol>
          </p>
          </span>
          </div>
        </div>
        <br>               
      </div>
    </div>
    <div class="center-content col-lg-4">

      <div class="pl-1 mt-3">
        <div class="card mt-3 bg-info">
          <div class="card-body"><span style="color: black">
          <h5>In-Demand Frameworks: </h5>
          <p>
            <ol>
              {% for f in frameworks %}
                <li>{{f}}</li>

              {% endfor %}

            </ol>
          </p>
          </span>
          </div>
        </div>
      </div>

    </div>
    <div class="right-content col-lg-4">

      <div class="pl-1 mt-3">
        <div class="card mt-3 bg-info">
          <div class="card-body"><span style="color: black">
          <h5>In-Demand Soft Skills: </h5>
          <p>
            <ol>
              {% for s in softskills %}
                <li>{{s}}</li>
              {% endfor %} 

            </ol>
          </p>
          </span>
          </div>
        </div>
        <br>
        <!-- <span class="text-light">
          <h5 style="font-size: 1rem">Average Salary: ${{ job_pay.pay }}<br> Lowest Salary: ${{ job_pay.lower_pay }}<br> Highest Salary: ${{ job_pay.upper_pay }}</h5>
        </span>                 -->
      </div>

    </div>
  </div>
  <div class="row justify-content-center">
    <div class="pl-4 mt-4">
      <h2>
        <a href={{ seek_url }} class="btn btn-light" style="width: 45%;">Browse This Job On Seek</a>
      </h2>
      <h2>
        <a href={{ indeed_url }} class="btn btn-light" style="width: 45%;">Browse This Job On Indeed</a>
      </h2></div>  
  </div>
</div>

<div class="row h-60 p-3 justify-content-center align-items-center">
      <div class="py-4 row w-100 border rounded shaded text-light" style="height: 40rem;">
      <div class="col-md-5" style="max-height: 100%; min-height: 60%;">
          <div id="map"></div>
          <div id="menu">
            <input id="mapbox/satellite-v9" type="radio" name="rtoggle" value="satellite" checked="checked">
            <!-- See a list of Mapbox-hosted public styles at -->
            <!-- https://docs.mapbox.com/api/maps/styles/#mapbox-styles -->
            <label for="mapbox/satellite-v9">satellite</label>
            <input id="mapbox/light-v10" type="radio" name="rtoggle" value="light">
            <label for="mapbox/light-v10">light</label>
            <input id="mapbox/dark-v10" type="radio" name="rtoggle" value="dark">
            <label for="mapbox/dark-v10">dark</label>
            <input id="mapbox/streets-v11" type="radio" name="rtoggle" value="streets">
            <label for="mapbox/streets-v11">streets</label>
            <input id="mapbox/outdoors-v11" type="radio" name="rtoggle" value="outdoors">
            <label for="mapbox/outdoors-v11">outdoors</label>
            <input id="smitcr7/ckmu1gkhy4k9s17pgprvhq1ub" type="radio" name="rtoggle" value="outdoors">
            <label for="smitcr7/ckmu1gkhy4k9s17pgprvhq1ub">Frank</label>
        </div>
      </div>
      <div class="col-md-7" style="max-height: 100%;">
          {% if regional_job_count_data_display %}
          <div id="container" class="py-5" style="width: 100%; margin:auto;">
            <canvas id="pie-chart2"></canvas>
          </div>
        {% else %}
              <p>There is no regional_job_count data matching your search criteria</p>
        {% endif %}
      </div>
    </div>   
  </div>
  <div class="row h-60 p-3 justify-content-center align-items-center">
    <div class="py-4 row w-100 border rounded shaded text-light" style="max-height: 35rem;">
    {% if work_type_data_display %}
      <div id="container" style="width: 75%; margin:auto;">
        <canvas id="pie-chart1" class="mb-4"></canvas>
      </div>
    {% else %}
          <p>There is no work_type data matching your search criteria</p>
    {% endif %}
  </div>
</div>

<div style="margin-left: .1rem;"class="my-4 py-4 row w-100 border rounded shaded text-light">
  <div class="col-md-12 tsne">
      {% if q %}
      <h3> Words commonly associated with '{{q}}'</h3>
      {% endif %}
      {% if close_words %}

    <div class="center-content col-lg-4">

      <div class="pl-1 mt-3">
        <div class="card mt-3 bg-info">
          <div class="card-body"><span style="color: black">
          <h5>In-Demand Frameworks: </h5>
          <p>
            <ol>
              {% for f in frameworks %}
                <li>{{f}}</li>

              {% endfor %}

            </ol>
          </p>
          </span>
          </div>
        </div>
      </div>

    </div>
      {% endif %}
      {% if error %}
      <div>
          <p>{{error}}</p>
      </div>
      {% endif %}
  </div>
</div>
  <div class="w-100"><a href="backend/" style="display: block; margin:auto;" class="btn btn-info my-3 px-4 py-1 w-25 h-75">Search Again</a></div>

<div  class="divider" style="height: 2rem; margin:auto; display:block;"></div>


  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
      <script>
    
        var config1 = {
          type: 'pie',
          data: {
            datasets: [{
              data: {{ work_type_data|safe }},
              backgroundColor: [
              '#59e379', '#fffd73', '#ff8324', '#db5858'
              ],
              label: 'Work Type'
            }],
            labels: {{ work_type_data_labels|safe }}
          },
          options: {
            title: {
              display: true,
              text: 'Full Time vs Part Time vs Contract vs Casual jobs',
		          verticalAlign: "center",
              fontColor: '#FFFFFF',
              fontSize: '20',
            },
            legend: {
                display: true,
                position: 'right',
                labels: {
                    fontColor: '#FFFFFF'
                }
            },
            responsive: true,
        }
        };
    
        var config2 = {
          type: 'pie',
          data: {
            datasets: [{
              data: {{ regional_job_count_data|safe }},
              backgroundColor: [
              '#26c005', '#137be5', '#c891c8', '#6d14b2', '#753efa', '#972e9d', '#25c8af', '#e858e5', '#59e379', '#fffd73', '#ff8324', '#db5858'
              ],
              label: 'Regional Job Count'
            }],
            labels: {{ regional_job_count_data_labels|safe }}
          },
          options: {
            title: {
              display: true,
              text: 'Number of jobs per region',
		          verticalAlign: "center",
              fontColor: '#FFFFFF',
              fontSize: '20',
            },
            legend: {
                display: true,
                position: 'right',
                labels: {
                    fontColor: '#FFFFFF'
                }
            },
            responsive: true,
        }
        };
    
        window.onload = function() {
          var ctx1 = document.getElementById('pie-chart1').getContext('2d');
          window.myPie = new Chart(ctx1, config1);

          var ctx2 = document.getElementById('pie-chart2').getContext('2d');
          window.myPie = new Chart(ctx2, config2);
        };
      </script>

</div>






<style>
 .marker {
  background-image: url('https://docs.mapbox.com/help/demos/custom-markers-gl-js/mapbox-icon.png');
  background-size: cover;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  cursor: pointer;
}
.mapboxgl-popup {
  max-width: 200px;
}
#map { width: 95%; height: 100% }

.mapboxgl-popup-content {
  text-align: center;
  font-family: 'Open Sans', sans-serif;
}
</style>
<script>

let markersOn = false

mapboxgl.accessToken = 'pk.eyJ1Ijoic21pdGNyNyIsImEiOiJja210eDR2anIwdzR2MnBuczY0ejd5bm96In0.2cXKqmqTnjjUiJEvXS4GGw';
var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/smitcr7/ckmu1gkhy4k9s17pgprvhq1ub', // style URL
        center: [173.621343, -41.376809], // starting position [lng, lat]
        zoom: 3 // starting zoom
});
var layerList = document.getElementById('menu');
var inputs = layerList.getElementsByTagName('input');

function switchLayer(layer) {
	var layerId = layer.target.id;
	map.setStyle('mapbox://styles/' + layerId);
}

for (var i = 0; i < inputs.length; i++) {
	inputs[i].onclick = switchLayer;
}

// Create a default Marker and add it to the map.

 var geojson = JSON.parse('{{geojson | escapejs}}');
 var region_count = JSON.parse('{{region_count | escapejs}}');
console.log(region_count)
 // add markers to map
const markers = () => {
  markersOn = true
geojson.features.forEach(function(marker, index) {


  // create a HTML element for each feature
  var el = document.createElement('div');
  el.className = 'marker';

  // make a marker for each feature and add to the map
  window.f = new mapboxgl.Marker(el)
    .setLngLat(marker.geometry.coordinates)
    .setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
    .setHTML('<span style="color: black">' + marker.text + " : " + region_count[marker.text] + " jobs available</span>"))
    .addTo(map);
});

}


map.on('zoomend', function() {
  if(map.getZoom() < 5) {
      $( ".marker" ).remove();
      map.setLayoutProperty('jobHeatMapArea', 'visibility', 'visible');

      markersOn = false;
  } else {
    if(markersOn == false) {
        markers();
        map.setLayoutProperty('jobHeatMapArea', 'visibility', 'none');
    }
  }
})


map.on('load', function() {
    // Add a geojson point source.
    // Heatmap layers also work with a vector tile source.
    map.addSource('jobAreas', {
        'type': 'geojson',
        'data': geojson
    });

    map.addLayer({
            'id': 'jobHeatMapArea',
            'type': 'heatmap',
            'source': 'jobAreas',
            'maxzoom': 9,
            'paint': {
                // Increase the heatmap weight based on frequency and property magnitude
                'heatmap-weight': [
                    'interpolate',
                    ['linear'],
                    ['get', 'mag'],
                    0,
                    0,
                    6,
                    1
                ],
                // Increase the heatmap color weight weight by zoom level
                // heatmap-intensity is a multiplier on top of heatmap-weight
                'heatmap-intensity': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    0,
                    1,
                    9,
                    3
                ],
                // Color ramp for heatmap.  Domain is 0 (low) to 1 (high).
                // Begin color ramp at 0-stop with a 0-transparancy color
                // to create a blur-like effect.
                'heatmap-color': [
                    'interpolate',
                    ['linear'],
                    ['heatmap-density'],
                    0,
                    'rgba(33,102,172,0)',
                    0.2,
                    'rgb(103,169,207)',
                    0.4,
                    'rgb(209,229,240)',
                    0.6,
                    'rgb(253,219,199)',
                    0.8,
                    'rgb(239,138,98)',
                    1,
                    'rgb(178,24,43)'
                ],
                // Adjust the heatmap radius by zoom level
                'heatmap-radius': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    0,
                    2,
                    9,
                    100
                ],
                // Transition from heatmap to circle layer by zoom level
                'heatmap-opacity': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    7,
                    1,
                    9,
                    0
                ]
            }
        },
        'waterway-label'
    );

    
});





map.addControl(new mapboxgl.NavigationControl());

</script>
{% endblock %}